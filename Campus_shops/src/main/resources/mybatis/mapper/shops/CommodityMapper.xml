<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mapper.CommodityMapper">

<!--个人中心start-->
    <!-- 插入商品
    insert语句插入。只有11个字段，少了以下字段：createtime,updatetime,endtime,commonstatus,rednumber-->
    <insert id="InsertCommodity" parameterType="com.entity.Commodity">
        insert into commodity (commid,commname,commdesc,videourl,orimoney,thinkmoney,school,common,category,image,userid) value
        (#{commid},#{commname},#{commdesc},#{videourl},#{orimoney},#{thinkmoney},#{school},#{common},#{category},#{image},#{userid})
    </insert>

    <!-- 查询商品详情
    根据主键commid查询商品详情，少了字段updatetime,endtime-->
    <select id="LookCommodity" resultType="com.entity.Commodity" parameterType="com.entity.Commodity">
        select commid,commname,commdesc,videourl,orimoney,thinkmoney,school,createtime,commstatus,common,rednumber,category,image,userid from commodity
        where commid=#{commid}
    </select>

    <!-- 修改商品
    根据主键commid修改商品相关信息，update一些属性（如果不为null）
    少了字段school,createtime,endtime,userid-->
    <update id="ChangeCommodity" parameterType="com.entity.Commodity">
        update commodity
        <set>
            <if test="commname!=null">
                commname=#{commname},
            </if>
            <if test="commdesc!=null">
                commdesc=#{commdesc},
            </if>
            <if test="videourl!=null">
                videourl=#{videourl},
            </if>
            <if test="orimoney!=null">
                orimoney=#{orimoney},
            </if>
            <if test="thinkmoney!=null">
                thinkmoney=#{thinkmoney},
            </if>
            <if test="rednumber!=null">
                rednumber=rednumber+1,
            </if>
            <if test="common!=null">
                common=#{common},
            </if>
            <if test="category!=null">
                category=#{category},
            </if>
            <if test="image!=null">
                image=#{image},
            </if>
            <if test="updatetime!=null">
                updatetime=#{updatetime},
            </if>
            <if test="commstatus!=null">
                commstatus=#{commstatus},
            </if>
        </set>
        where commid=#{commid}
    </update>

    <!-- 修改商品状态
    根据主键commid，只修改状态commstatus-->
    <update id="ChangeCommstatus">
        update commodity set commstatus=#{commstatus} where commid=#{commid}
    </update>

    <!-- 通过商品名分页模糊查询

    根据商品名称(使用like进行模糊查询)和commstatus=1正常状态查询商品
    少了字段videourl,endtime,commstatus,common,rednumber,category,userid

    desc从大到小排序（降序），默认asc升序排序。
    https://blog.csdn.net/weixin_42882887/article/details/103051023
    根据文章内容，可以将最后三行看作从小到大排序后取？其实就是倒数page+count行。-->
    <select id="queryCommodityByName" resultType="com.entity.Commodity">
        select commid,commname,commdesc,orimoney,thinkmoney,school,updatetime,image
        from commodity
        where commname like #{commname} and commstatus=1
        order by
        updatetime desc
        LIMIT #{page},#{count}
    </select>

    <!--模糊查询商品总数
    根据商品名称模糊查询，查询总条数，估计是前台用的。-->
    <select id="queryCommodityByNameCount" resultType="java.lang.Integer">
        select count(*) from commodity where commname like #{commname} and commstatus=1
    </select>




    <!-- 分页展示各类状态的商品信息

    个人中心-商品管理-商品清单-选择状态（全部商品、待审核、正常、违规、已售出）
        //后台的商品管理也用到（一模一样的，这也难怪一开始搞错个人中心和后台）
    comid应该是用于按钮“详情”
    commid,commname,commdesc,updatetime,category,commstatus显示在列表中
    commstatus则是为了根据状态显示对应的按钮

    （//无用）少了字段videourl,orimoney,thinkmoney,school,createtime,endtime,common,rednumber,image,userid
     -->
    <select id="queryAllCommodity" resultType="com.entity.Commodity">
        select commid,commname,commdesc,updatetime,category,commstatus
        from commodity
<!--        <where>-->
<!--            <if test="commstatus != null and commstatus != 2">and commstatus = #{commstatus}</if>-->
<!--            <if test="userid != null">and userid = #{userid}</if>-->
<!--        </where>-->
        <where>
            <!--mybatis中用chooese表示if-else
            https://blog.csdn.net/qq_34886018/article/details/86478403-->
            <choose>
                <!--commstatus == null其实表示commstatus == 100，是CommodityController.java强行设置为null的-->
                <when test="commstatus == null">
                    and commstatus != 2
                </when>
<!--                <when test="commstatus != null and commstatus != 2">-->
                <when test="commstatus != null">
                    and commstatus = #{commstatus}
                </when>
            </choose>
            <!--管理员那边默认将userid设置为null-->
            <if test="userid != null">and userid = #{userid}</if>
        </where>
        order by
        updatetime desc
        limit #{page},#{count}
    </select>




    <!-- 查询商品各类状态的总数
     应该是和上一个queryAllCommodity匹配的。用于分页？-->
    <select id="queryCommodityCount" resultType="java.lang.Integer">
        select count(*) from commodity
        <!--        <where>-->
        <!--            <if test="commstatus != null and commstatus != 2">and commstatus = #{commstatus}</if>-->
        <!--            <if test="userid != null">and userid = #{userid}</if>-->
        <!--        </where>-->
        <where>
            <!--mybatis中用chooese表示if-else-->
            <choose>
                <!--commstatus == null其实表示commstatus == 100，是CommodityController.java强行设置为null的-->
                <when test="commstatus == null">
                    and commstatus != 2
                </when>
<!--                <when test="commstatus != null and commstatus != 2">-->
                <when test="commstatus != null">
                    and commstatus = #{commstatus}
                </when>
            </choose>
            <!--管理员那边默认将userid设置为null-->
            <if test="userid != null">and userid = #{userid}</if>
        </where>
    </select>
<!--个人中心end-->







<!--前台start-->
    <!-- 首页分类展示8条商品
    前台首页，展示八个分类对应的商品-->
    <select id="queryCommodityByCategory" resultType="com.entity.Commodity">
        select commid,commname,commdesc,orimoney,thinkmoney,school,updatetime,image
        from commodity
        <where>
            <if test="category != '全部'">and category = #{category}</if>
            and commstatus=1
        </where>
            order by updatetime desc limit 0,8
    </select>

    <!-- 产品清单分类分页展示商品
     前台的商品清单。-->
    <select id="queryAllCommodityByCategory" resultType="com.entity.Commodity">
        select commid,commname,orimoney,thinkmoney,school,updatetime,image
        from commodity
        <where>
            <if test="category != '全部'">and category = #{category}</if>
            <if test="(minmoney != null) and (maxmoney != null)">and thinkmoney between #{minmoney} and #{maxmoney}</if>
            <if test="area == '附近'">and school != #{school}</if>
            <if test="area == '本校'">and school = #{school}</if>
            and commstatus=1
        </where>
        order by updatetime desc limit #{page},#{count}
    </select>

    <!-- 查询产品清单分类分页展示商品的总数
    前台的商品清单。-->
    <select id="queryAllCommodityByCategoryCount" resultType="java.lang.Integer">
        select count(*) from commodity
        <where>
            <if test="category != '全部'">and category = #{category}</if>
            <if test="minmoney != null">and thinkmoney &gt;= #{minmoney}</if>
            <if test="maxmoney != null">and thinkmoney &lt;= #{maxmoney}</if>
            <if test="area == '附近'">and school != #{school}</if>
            <if test="area == '本校'">and school = #{school}</if>
            and commstatus=1
        </where>
    </select>
</mapper>
